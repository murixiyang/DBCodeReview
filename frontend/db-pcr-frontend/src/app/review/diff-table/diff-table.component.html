<div class="diff-grid">
  <!-- Header items -->
  <div class="diff-header-file">
    <strong>{{ file }}</strong>
  </div>
  <div class="diff-header-stats">
    <span class="insertions">+++ {{ insertedCount }}</span>
    <span class="deletions">--- {{ deletedCount }}</span>
  </div>

  <!-- Old Pane -->
  <div class="pane old-pane">
    <table class="diff-table">
      <ng-container *ngFor="let line of lines; let i = index">
        <!-- code row -->
        <tr
          (click)="selectLine(i)"
          [ngClass]="{
            'diff-insert': line.type === 'insert',
            'diff-delete': line.type === 'delete',
            'diff-selected': selectedIndex === i
          }"
        >
          <td class="num-col">{{ line.oldNumber || "-" }}</td>
          <td class="code-col">
            <pre>{{ line.oldText }}</pre>
          </td>
        </tr>

        <!-- real comments on PARENT side -->
        <tr *ngIf="hasComments(line.newNumber, 'PARENT')" class="comment-cell">
          <td colspan="2">
            <ng-container
              *ngFor="let c of publishedFor(file, line.newNumber!, 'PARENT')"
            >
              <app-comment-box
                variant="published"
                [comment]="c"
              ></app-comment-box>
            </ng-container>
            <ng-container
              *ngFor="let d of draftFor(file, line.newNumber!, 'PARENT')"
            >
              <app-comment-box variant="draft" [comment]="d"></app-comment-box>
            </ng-container>
          </td>
        </tr>

        <!-- placeholder when NEW has comments but OLD does not -->
        <tr
          *ngIf="
            !hasComments(line.newNumber, 'PARENT') &&
            hasComments(line.newNumber, 'REVISION')
          "
          class="comment-cell placeholder-row"
        >
          <td colspan="2">
            <app-comment-box variant="placeholder"></app-comment-box>
          </td>
        </tr>

        <!-- new‐comment box when that line is selected -->
        <tr *ngIf="selectedIndex === i" class="comment-cell new-comment">
          <td colspan="2">
            <app-comment-box
              variant="new"
              [comment]="newDraft!"
              (saved)="onSaveDraft($event, 'PARENT')"
              (canceled)="onCancelDraft()"
            ></app-comment-box>
          </td>
        </tr>
      </ng-container>
    </table>
  </div>

  <!-- New Pane -->
  <div class="pane new-pane">
    <table class="diff-table">
      <ng-container *ngFor="let line of lines; let i = index">
        <!-- code row -->
        <tr
          (click)="selectLine(i)"
          [ngClass]="{
            'diff-insert': line.type === 'insert',
            'diff-delete': line.type === 'delete',
            'diff-selected': selectedIndex === i
          }"
        >
          <td class="num-col">{{ line.newNumber || "-" }}</td>
          <td class="code-col">
            <pre>{{ line.newText }}</pre>
          </td>
        </tr>

        <!-- placeholder when OLD has comments but NEW does not -->
        <tr
          *ngIf="
            !hasComments(line.newNumber, 'REVISION') &&
            hasComments(line.newNumber, 'PARENT')
          "
          class="comment-cell placeholder-row"
        >
          <td colspan="2">
            <app-comment-box variant="placeholder"></app-comment-box>
          </td>
        </tr>

        <!-- real comments on REVISION side -->
        <tr
          *ngIf="hasComments(line.newNumber, 'REVISION')"
          class="comment-cell"
        >
          <td colspan="2">
            <ng-container
              *ngFor="let c of publishedFor(file, line.newNumber!, 'REVISION')"
            >
              <app-comment-box
                variant="published"
                [comment]="c"
              ></app-comment-box>
            </ng-container>

            <ng-container
              *ngFor="let d of draftFor(file, line.newNumber!, 'REVISION')"
            >
              <!-- <app-comment-box variant="draft" [comment]="d"></app-comment-box> -->

              <!-- If this is the one being edited… -->
              <app-comment-box
                *ngIf="editingDraft?.id === d.id; else showDraft"
                variant="update"
                [comment]="editingDraft!"
                (saved)="onUpdateDraft($event, 'REVISION')"
                (canceled)="onCancelUpdate()"
              ></app-comment-box>

              <!-- Otherwise, show the normal draft view -->
              <ng-template #showDraft>
                <app-comment-box
                  variant="draft"
                  [comment]="d"
                  (edited)="onEditDraft($event)"
                  (deleted)="onDeleteDraft($event)"
                ></app-comment-box>
              </ng-template>
            </ng-container>
          </td>
        </tr>

        <!-- new‐comment box when that line is selected -->
        <tr *ngIf="selectedIndex === i" class="comment-cell new-comment">
          <td colspan="2">
            <app-comment-box
              variant="new"
              [comment]="newDraft!"
              (saved)="onSaveDraft($event, 'REVISION')"
              (canceled)="onCancelDraft()"
            ></app-comment-box>
          </td>
        </tr>
      </ng-container>
    </table>
  </div>
</div>
