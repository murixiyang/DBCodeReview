<div>
  <button (click)="onOpenPublishDialog()">Submit Review</button>

  <app-publish-dialog
    *ngIf="showPublishDialog"
    [count]="draftComments.length"
    (confirm)="onPublishConfirmed($event)"
    (cancel)="showPublishDialog = false"
  ></app-publish-dialog>
</div>

<div>
  Overall comment:
  <div *ngFor="let c of overallComments">
    <app-comment-box
      *ngIf="c"
      variant="published"
      [authorName]="getDisplayName(c)"
      [comment]="c.commentInfo"
    ></app-comment-box>
  </div>
</div>

<div class="diff-grid">
  <!-- Header items -->
  <div class="diff-header-file">
    <strong>{{ file }}</strong>
  </div>
  <div class="diff-header-stats">
    <span class="insertions">+++ {{ insertedCount }}</span>
    <span class="deletions">--- {{ deletedCount }}</span>
  </div>

  <!-- Old Pane -->
  <div class="pane old-pane">
    <table class="diff-table">
      <ng-container *ngFor="let line of lines; let i = index">
        <!-- code row -->
        <tr
          [ngClass]="{
            'diff-insert': line.type === 'insert',
            'diff-delete': line.type === 'delete',
            'diff-selected': selectedIndex === i
          }"
        >
          <td class="num-col">{{ line.oldNumber || "-" }}</td>
          <td class="code-col">
            <pre>{{ line.oldText }}</pre>
          </td>
        </tr>

        <!-- Placeholder comment -->
        <tr
          *ngIf="hasComments(line.newNumber, 'REVISION') || selectedIndex === i"
          class="comment-cell placeholder-row"
          [style.height.px]="placeholderHeights[i] || 0"
        >
          <td colspan="2">
            <app-comment-box variant="placeholder"></app-comment-box>
          </td>
        </tr>
      </ng-container>
    </table>
  </div>

  <!-- New Pane -->
  <div class="pane new-pane">
    <table class="diff-table">
      <ng-container *ngFor="let line of lines; let i = index">
        <!-- code row -->
        <tr
          (click)="selectLine(i)"
          [ngClass]="{
            'diff-insert': line.type === 'insert',
            'diff-delete': line.type === 'delete',
            'diff-selected': selectedIndex === i
          }"
        >
          <td class="num-col">{{ line.newNumber || "-" }}</td>
          <td class="code-col">
            <pre>{{ line.newText }}</pre>
          </td>
        </tr>

        <!-- real comments on REVISION side -->
        <tr
          #measureRow
          [attr.data-line]="i"
          *ngIf="hasComments(line.newNumber, 'REVISION')"
          class="comment-cell"
        >
          <td colspan="2">
            <ng-container
              *ngFor="let c of publishedFor(file, line.newNumber!, 'REVISION')"
            >
              <!-- 1) the published comment -->
              <div [ngClass]="{ 'reply-container': c.commentInfo.inReplyTo }">
                <app-comment-box
                  variant="published"
                  [authorName]="getDisplayName(c)"
                  [comment]="c.commentInfo"
                  (reply)="onReply(c.commentInfo, 'REVISION')"
                ></app-comment-box>
              </div>

              <!-- 2) the inline reply‐box, only for that comment -->
              <div class="reply-container">
                <app-comment-box
                  *ngIf="replyingTo?.id === c.commentInfo.id"
                  variant="new"
                  [comment]="replyDraft!"
                  (saved)="onSaveReply($event)"
                  (canceled)="onCancelReply()"
                ></app-comment-box>
              </div>
            </ng-container>

            <ng-container
              *ngFor="let d of draftFor(file, line.newNumber!, 'REVISION')"
            >
              <div [ngClass]="{ 'reply-container': d.inReplyTo }">
                <!-- If this is the one being edited… -->
                <app-comment-box
                  *ngIf="editingDraft?.id === d.id; else showDraft"
                  variant="update"
                  [comment]="editingDraft!"
                  (saved)="onUpdateDraft($event)"
                  (canceled)="onCancelUpdate()"
                ></app-comment-box>

                <!-- Otherwise, show the normal draft view -->
                <ng-template #showDraft>
                  <app-comment-box
                    variant="draft"
                    [comment]="d"
                    (edited)="onEditDraft($event)"
                    (deleted)="onDeleteDraft($event)"
                  ></app-comment-box>
                </ng-template>
              </div>
            </ng-container>
          </td>
        </tr>

        <!-- new‐comment box when that line is selected -->
        <tr
          #measureRow
          [attr.data-line]="i"
          *ngIf="selectedIndex === i"
          class="comment-cell new-comment"
        >
          <td colspan="2">
            <app-comment-box
              variant="new"
              [comment]="newDraft!"
              (saved)="onSaveDraft($event, 'REVISION')"
              (canceled)="onCancelDraft()"
            ></app-comment-box>
          </td>
        </tr>
      </ng-container>
    </table>
  </div>
</div>
